# Start Here

`Name`: Sarah Huang  
`NetID`: shuang24

Note: I used Microsoft Edge for most if not all of the lab.

For each problem below, you will,

1. List the steps necessary to execute the exploit.
2. An explanation of what the vulnerability was.
3. An explanation of how you would patch the vulnerability.
4. If the challenge had a patch portion, enter the code used to patch the challenge.

--

## Scoreboard 

### Steps
1. Starting on the Juice Shop home page, open Inspector (using Chrome)
2. Click the Sources tab and navigate to main.js
3. Search "score" until you find a line "routerLink", "/score-board"
4. Enter the web address http://localhost:3000/#/score-board
---

## DOM XSS 

### Exploit steps
1. Type <iframe src="javascript:alert(`xss`)"> into the search bar

### Explanation
While the problem code made a harmless alert, an attacker could use malicious javascript to interfere with the website operations.

### Patch
The problem was using Angular's built-in sanitization when there shouldn't be any HTML code entered in the search bar.
The easy fix is to remove the bypass of sanitization so everything is evaluated as plain text.

### Patch code
this.searchValue = queryParam

---

## Reflected XSS

### Exploit steps
1. Login to an account (create one if you haven't)
2. Buy an item and go through the ordering process
3. Account > Orders & Payment > Order History > Track Order (click little truck)
4. Change the id to the javascript code <iframe src="javascript:alert(`xss`)">
http://localhost:3000/#/track-result?id=%3Ciframe%20src%3D%22javascript:alert(%60xss%60)%22%3E

### Explanation
The tracking order URL has now been modified to include a XSS attack. If another user of the website requests the attacker's URL, 
the attacker's script will execute in the victim user's browser. The malicious user may be able to view and modify the victim's 
information. 

### Patch
Have a list of acceptable ids because the user can type in anything for the id on the tracking page. Maybe implement a content-security
policy in the response header that tells the browser to not execute inline Javascript and lock down domains tha tcan host Javascript for a page.

### Patch code
Not applicable

---

## Forged Review

### Exploit steps
1. Use Microsoft Edge because I couldn't figure out how to edit and resend HTTP calls in Chrome
2. Make two accounts- one to make the review, the other to change the email to
    juicedeuce@gmail.com
    juicedeuce

    hacker@gmail.com
    hacker
3. Make a review using hacker@gmail.com for any product (I chose Apple Juice 1000ml)
4. Go to Inspect mode, click Network tab, and find the PUT request
5. Select "Edit and Resend" > "Body" and change the author from "hacker@gmail.com" to "juicedeuce@gmail.com"
6. Hit "send" and the user email should be updated

### Explanation
If the application is not handling access control properly, a malicious user could grant themselves special administrative permissions.
They could manipulate other user's accounts or access parts of the application without clearance.

### Patch
To prevent the user from passing any other account's email in the request, the code to for reviews should require the author's email from
the authentication token in the HTTP request.

### Patch code
{ _id: req.body.id, author: user.data.email },

---

## Login Admin

### Exploit steps
1. On the login screen, enter a random username and password
2. Open Inspect > Network to find the HTTP request and select "Edit and Resend"
3. Enter ' as the email - it should return SQL code meaning it's vulnerable to SQL injection
4. Type in "' or 1=1 --" in the email, the password can stay random
    ' will stop the email query
    "or 1=1" is a true condition to replace the email search
    "--" comments out the rest of the query so it doesn't check for a password
    It returns the first user which is the admin account

### Explanation
If the application is vulnerable to SQL injection attacks, a malicious user can login with the admin account or another user's to cause trouble.

### Patch
Prevent the query from getting tampered with query syntax using the built-in binding mechanism of Sequelize to make it a 
prepared statement. Prepared statements make sure that the intent of a query is unchangeable, even if SQL commands are inserted by an attacker.

### Patch code
models.sequelize.query(`SELECT * FROM Users WHERE email = $1 AND password = $2 AND deletedAt IS NULL`,
    { bind: [ req.body.email, security.hash(req.body.password) ], model: models.User, plain: true })

---

## Admin Section

### Exploit steps
1. From the "Login Admin" step, enter the email as "' or '1'='1' --" and any password to use the admin login
2. Navigate to Inspect > Source and search until you find the administration path
        path: "administration",
        component: pa,
        canActivate: [Gt]
3. In the search bar, type http://localhost:3000/#/administration

### Explanation
To build off of the "Login Admin" step, a malicious user could get ahold of the admin account and access parts of the application
they do not have clearance for. 

### Patch
It is safer to internally host a separate admin backend application that can't be accessed through the website.

### Patch code
/* TODO: Externalize admin functions into separate application
        that is only accessible inside corporate network.
*/
// {
//   path: 'administration',
//   component: AdministrationComponent,
/   canActivate: [AdminGuard]
// },
---

## Admin Registration

### Exploit steps
1. Search the main.js for any clues about roles and admin
    return !(!e?.data || "admin" !== e.data.role) || (this.loginGuard.forbidRoute(),
2. Go to the Login page and make a new account
    hackeradmin1@gmail.com
    hackeradmin1
3. Navigate to Inspect > Networks, find the POST Users call, and click "Edit and Resend"
4. Edit the call and add the param "role":"admin" to make the user account an admin 
{"email":"hackeradmin1@gmail.com","password":"hackeradmin1","passwordRepeat":"hackeradmin1","role":"admin","securityQuestion":{"id":2,"question":"Mother's maiden name?","createdAt":"2023-04-15T03:14:09.160Z","updatedAt":"2023-04-15T03:14:09.160Z"},"securityAnswer":"hackeradmin1"}

### Explanation
In the current code, the role is not assigned to every newly created account.
If a malicious user can find a way to assign themselves as an admin, they don't have to go through the trouble of figuring out the admin account
and easily access special permissions. They could also assign themselves a different role besides customer and disrupt the system by breaking it or
accessing something they shouldn't.

### Patch
Every time you create a new account, immediately assign the account role as a customer.

### Patch code
 context.instance.role = 'customer'

---

## API-Only XSS

### Exploit steps
1. Navigate to Inspect > Network in the browser and find http://localhost:3000/api/Quantitys/
2. Click "Edit and Resend" and change the GET call to http://localhost:3000/api/Products/4
   It should return information on one item - Raspberry Juice (1000ml)
3. Change the HTTP call to PUT
4. In the request body, write {"description": "<iframe src=\"javascript:alert(`xss`)\">"}
5. Send the request and it should trigger the XSS attack

### Explanation
The malicious user doesn't even need to steal account information. With this vulnerability, they can just make
an API call without arousing any visible alarm on the site. 

### Patch
Remove the bypass of sanitization. Also, users should be unable to change product descriptions.

### Patch code
All of this code is deleted
// this.trustProductDescription(products)
// }
//trustProductDescription (tableData: any[]) {
//for (let i = 0; i < tableData.length; i++) {
//tableData[i].description = this.sanitizer.bypassSecurityTrustHtml(tableData[i].description)
//}
---

## Database Schema

### Exploit steps
1. Use the search bar to search something random
2. Inspect > Network and look for search?q= to Edit and Resend
   If you type "apple" as the value, you should get SQL about it in return 
   If you type "apple'", you get an error 
3. Create the request
    - Find the number of column in the Product table - 9
    - sqlite_master has all the information about the databases
    - UNION SELECT combines all the queried table entries into one result

http://localhost:3000/rest/products/search?q=apple')) UNION SELECT sql,2,3,4,5,6,7,8,9 FROM sqlite_master--
http://localhost:3000/rest/products/search?q='))%20UNION%20SELECT%20sql%2C2%2C3%2C4%2C5%2C6%2C7%2C8%2C9%20FROM%20sqlite_master--

### Explanation
SQL injections can reveal database information like passwords and payment information to malicious users. 

### Patch
Prevent the query from getting tampered with query syntax using the built-in replacement mechanism of Sequelize to make it a 
prepared statement. Prepared statements make sure that the intent of a query is unchangeable, even if SQL commands are inserted by an attacker.
The replacements option replaces the criteria placeholder in the query with the actual search term.

### Patch code
 models.sequelize.query(
    `SELECT * FROM Products WHERE ((name LIKE '%:criteria%' OR description LIKE '%:criteria%') AND deletedAt IS NULL) ORDER BY name`,
        { replacements: { criteria } }
    ).then(([products]: any) => {
